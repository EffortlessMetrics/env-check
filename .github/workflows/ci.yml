name: ci

on:
  push:
  pull_request:

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: dtolnay/rust-toolchain@stable
        with:
          components: llvm-tools-preview, rustfmt, clippy

      - uses: taiki-e/install-action@cargo-llvm-cov

      - name: fmt
        run: cargo fmt --all -- --check

      - name: clippy
        run: cargo clippy --all-targets --all-features -- -D warnings

      - name: test (coverage)
        run: cargo llvm-cov --all --fail-under-lines 100

      - name: bdd
        run: cargo test -p env-check-cli --test bdd

      - name: schema-check
        run: cargo run -p xtask -- schema-check

      - name: conform
        run: cargo run -p xtask -- conform

  mutants:
    # Timebox mutation testing; keep it non-blocking initially.
    runs-on: ubuntu-latest
    continue-on-error: true
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - name: cargo-mutants
        run: |
          cargo install cargo-mutants || true
          cargo mutants -p env-check-domain --timeout 300
